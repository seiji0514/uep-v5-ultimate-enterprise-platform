# バックエンド再構築ガイド

**作成日**: 2026年1月30日

---

## 概要

バックエンドを完全に再構築する手順を説明します。仮想環境の再作成から依存関係のインストール、起動確認まで行います。

---

## 再構築手順

### 方法1: 再構築スクリプトを使用（推奨）

**重要**: 再構築前に、すべてのコマンドプロンプトとエディタを閉じてください。

1. **完全再構築スクリプトを実行**（仮想環境を削除して再作成）:
   ```cmd
   rebuild-backend.bat
   ```

   このスクリプトは以下を自動的に実行します：
   - Pythonプロセスの終了
   - 既存の仮想環境の削除
   - 新しい仮想環境の作成
   - pipのアップグレード
   - 依存関係のインストール

2. **安全版スクリプトを実行**（仮想環境を削除せずに上書き）:
   
   「Access is denied」エラーが発生する場合は、安全版を使用してください：
   ```cmd
   rebuild-backend-safe.bat
   ```

   このスクリプトは以下を実行します：
   - Pythonプロセスの終了
   - 既存の仮想環境を保持（削除しない）
   - 依存関係の再インストール（上書き）

2. **バックエンドを起動**:
   ```cmd
   start-backend.bat
   ```

   または、手動で起動：
   ```cmd
   cd backend
   venv\Scripts\activate
   python main.py
   ```

### 方法2: 手動で再構築

1. **既存の仮想環境を削除**:
   ```cmd
   cd backend
   rmdir /s /q venv
   ```

2. **新しい仮想環境を作成**:
   ```cmd
   python -m venv venv
   ```

3. **仮想環境をアクティベート**:
   ```cmd
   venv\Scripts\activate
   ```

4. **pipをアップグレード**:
   ```cmd
   python -m pip install --upgrade pip
   ```

5. **依存関係をインストール**:
   ```cmd
   pip install -r requirements.txt
   ```

6. **バックエンドを起動**:
   ```cmd
   python main.py
   ```

---

## 確認事項

再構築後、以下を確認してください：

1. **バックエンドが正常に起動する**:
   - コマンドプロンプトに「Application startup complete.」が表示される
   - 警告やエラーが表示されない

2. **APIエンドポイントにアクセスできる**:
   - `http://localhost:8000` - ルートエンドポイント
   - `http://localhost:8000/docs` - APIドキュメント
   - `http://localhost:8000/health` - ヘルスチェック

3. **エラーがない**:
   - `performance_optimizer`関連のエラーが発生しない
   - インポートエラーが発生しない
   - 警告が表示されない（または抑制されている）

---

## トラブルシューティング

### 「Access is denied」エラーが発生する場合

1. **すべてのコマンドプロンプトとエディタを閉じる**
2. **Pythonプロセスが実行中でないか確認**:
   ```cmd
   tasklist | findstr python.exe
   ```
   実行中の場合は終了：
   ```cmd
   taskkill /F /IM python.exe /T
   ```
3. **安全版スクリプトを使用**:
   ```cmd
   rebuild-backend-safe.bat
   ```
4. **それでも解決しない場合**:
   - `backend\venv`フォルダを手動で削除
   - 管理者権限でコマンドプロンプトを開いて再実行

### 仮想環境の作成に失敗する場合

- Python 3.11以上がインストールされているか確認
- 管理者権限で実行してみる

### 依存関係のインストールに失敗する場合

- インターネット接続を確認
- プロキシ設定を確認
- `pip install --upgrade pip`を実行してから再試行

### バックエンドが起動しない場合

- `backend/.env`ファイルが存在するか確認
- ポート8000が使用可能か確認
- `docs/TROUBLESHOOTING.md`を参照

---

## 注意事項

- 再構築すると、仮想環境内のすべてのパッケージが削除されます
- カスタム設定がある場合は、再構築前にバックアップを取ってください
- `.env`ファイルは削除されませんが、必要に応じて再作成されます

---

以上
